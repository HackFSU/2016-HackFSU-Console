// Generated by CoffeeScript 1.9.1

/*
For: /user/help
 */

(function() {
  var FADE_TIME, REFRESH_TIME, dtSettings_hidden, dtSettings_requests, hide, socket;

  FADE_TIME = 100;

  REFRESH_TIME = 10000;

  dtSettings_requests = {
    order: [[0, 'desc']],
    aLengthMenu: [[25, 50, 75, -1], [25, 50, 75, "All"]],
    iDisplayLength: 25,
    autoWidth: true
  };

  dtSettings_hidden = {
    order: [[0, 'desc']],
    aLengthMenu: [[25, 50, 75, -1], [25, 50, 75, "All"]],
    iDisplayLength: 25,
    autoWidth: true
  };

  socket = io('/user/help');

  $(document).ready(function() {
    var currTab, dtHidden, dtRequests, hiddenBy, refreshTabs;
    currTab = [0, 0];
    dtHidden = $('#DT-hidden').DataTable(dtSettings_hidden);
    dtRequests = $('#DT-requests').DataTable(dtSettings_requests);
    hiddenBy = '';
    $('button[name="hide"]').click(function() {
      console.log("clicked");
      hide($(this), $(this).attr('data-objectId'));
    });
    socket.on('request hidden', function(msg) {
      var data;
      data = dtRequests.row('#' + msg).data();
      data[3] = $('#sessionUser').text();
      dtHidden.row.add(data).draw();
      return dtRequests.row('#' + msg).remove().draw();
    });
    refreshTabs = function() {
      $('a[role="tab"]').click(function(e) {
        var href;
        e.preventDefault();
        href = $(this).attr('href');
        switch (href) {
          case '#requests':
            if (currTab[0] !== 0) {
              $('#hidden').hide();
              $('#requests').show();
              return currTab[0] = 0;
            }
            break;
          case '#hidden':
            if (currTab[0] !== 1) {
              $('#requests').hide();
              $('#hidden').show();
              return currTab[0] = 1;
            }
            break;
          default:
            return console.log('Invalid tab id');
        }
      });
      return $(this).tab('show');
    };
    refreshTabs();
    return setInterval(function() {
      return location.reload(true);
    }, REFRESH_TIME);
  });

  hide = function($btn, objectId) {
    $('button[data-objectId="' + objectId + '"]').attr('disabled', 'disabled');
    $btn.text('...');
    $('#loading img').fadeTo(FADE_TIME, 1);
    console.log('Hiding ' + objectId);
    return $.ajax({
      type: 'POST',
      url: '/user/help_hide',
      data: JSON.stringify({
        objectId: objectId
      }),
      contentType: 'application/json',
      success: function(res) {
        console.log(JSON.stringify(res, void 0, 2));
        if (res.success) {
          $btn.text('Done!');
          socket.emit('help hide', objectId);
        } else {
          $btn.text('Error!');
          $('button[data-objectId="' + objectId + '"]').removeAttr('disabled', 'disabled');
        }
        $('#loading img').fadeTo(FADE_TIME, 0);
      },
      error: function() {
        $btn.text('Error!');
        $('button[data-objectId="' + objectId + '"]').removeAttr('disabled', 'disabled');
      }
    });
  };

}).call(this);
