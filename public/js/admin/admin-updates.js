// Generated by CoffeeScript 1.8.0

/*
For /admin/updates
 */

(function() {
  var displayEnd, dtSettings, endInError, endInSuccess, validate;

  dtSettings = {
    order: [[2, 'desc']],
    aLengthMenu: [[10, 20, 30, -1], [10, 20, 30, "All"]],
    iDisplayLength: -1,
    autoWidth: true
  };

  $(document).ready(function() {
    return $('#DT').DataTable(dtSettings);
  });

  $('#newUpdateFrom').submit(function(event) {
    var obj, prompt, val;
    event.preventDefault();
    obj = {
      title: $('#title').val(),
      subtitle: $('#subtitle').val(),
      sendPush: $('#sendPush').is(':checked')
    };
    val = validate(obj);
    $('label').removeClass('hasInputError');
    $('.form-error-msg').text('');
    if (val !== true) {
      $('label[for="' + val["for"] + '"]').addClass('hasInputError');
      $('.form-error-msg').text(val.msg);
      $('#submit').shakeIt();
    } else {
      prompt = 'Are you sure you want to create this update?\n\n' + obj.title + '\n\n' + obj.subtitle + '\n\n' + 'Push=' + obj.sendPush;
      if (confirm(prompt)) {
        $('#submit').text('Submitting...');
        $.ajax({
          type: 'post',
          url: '/admin/updates_create',
          data: obj,
          success: function(res) {
            if (res.success === true) {
              return endInSuccess();
            } else {
              return endInError();
            }
          },
          error: function(res) {
            if (res.msg != null) {
              console.log('ERROR: ' + res.msg);
            }
            return endInError();
          }
        });
      }
    }
  });

  validate = function(obj) {
    if (!obj.title.trim()) {
      return {
        "for": 'title',
        msg: 'Missing title!'
      };
    } else if (!obj.subtitle.trim()) {
      return {
        "for": 'subtitle',
        msg: 'Missing subtitle!'
      };
    }
    return true;
  };

  endInError = function() {
    var sub;
    sub = $('#submit');
    return sub.fadeOut(500, function() {
      sub.text('Error!');
      sub.attr('disabled', 'true');
      sub.fadeIn(500, function() {});
      return displayEnd("An unexpected error has occured!", "Refresh this window and try resubmitting.");
    });
  };

  endInSuccess = function() {
    var sub;
    sub = $('#submit');
    return sub.fadeOut(500, function() {
      sub.text('Success!');
      sub.attr('disabled', 'true');
      sub.fadeIn(500, function() {});
      return displayEnd("Update created!", "Refresh this page to see it in the table below.");
    });
  };

  displayEnd = function(header, subtext) {
    $('input').attr('disabled', 'disabled');
    $('checkbox').attr('disabled', 'disabled');
    $('select').attr('disabled', 'disabled');
    return $('#newUpdateFrom').fadeTo(1000, 0, function() {
      var $newMsg;
      $newMsg = $("<div id='endDisplay'><h3>" + header + "</h3><h4>" + subtext + "</h4>");
      $newMsg.prependTo($('.form-container')).fadeIn(1000, function() {
        return $("html, body").animate({
          scrollTop: 0
        }, 500);
      });
    });
  };

}).call(this);
