// Generated by CoffeeScript 1.8.0

/*
For: /user/help
 */

(function() {
  var FADE_TIME, REFRESH_SPEED, checkIn, dtSettings_checkIns, refreshStatusCounts, socket;

  FADE_TIME = 100;

  dtSettings_checkIns = {
    order: [[0, 'asc']],
    aLengthMenu: [[50, 100, 150, -1], [50, 100, 150, "All"]],
    iDisplayLength: 25,
    autoWidth: true
  };

  socket = io('/admin/checkins');

  $(document).ready(function() {
    var table;
    $('button[name="checkin"]').click(function() {
      console.log("Check In Clicked!");
      checkIn($(this), $(this).attr('data-objectId'));
    });
    table = $('#DT-checkins').DataTable(dtSettings_checkIns);
    refreshStatusCounts();
    setInterval(function() {
      return refreshStatusCounts();
    }, REFRESH_SPEED);
    socket.on('checked in', function(msg) {
      console.log('Checked in: ' + msg);
      table.cell('#' + msg, '#status').data('<img src="/img/checkedIn.png"></img>').draw();
      return table.cell('#' + msg, '#functions').data('N/A').draw();
    });
  });

  REFRESH_SPEED = 60000;

  refreshStatusCounts = function() {
    console.log('Refreshing status counts...');
    $('#loading img').fadeTo(FADE_TIME, 1);
    return $.ajax({
      type: 'POST',
      url: '/admin/checkins_getStatusCounts',
      data: JSON.stringify({}),
      contentType: 'application/json',
      success: function(res) {
        if (res.success) {
          console.log('Success counting status counts!');
          $('#total').text('TOTAL  ' + res.counts.total);
          $('#expected').text('EXPECTED  ' + res.counts.expected);
          $('#checkedin').text('CHECKED IN  ' + res.counts.checkedIn);
        } else {
          console.log('Error counting status counts!');
          $('#total').text('TOTAL  ERR');
          $('#expected').text('EXPECTED  ERR!');
          $('#checkedin').text('CHECKED IN  ERR!');
        }
        $('#loading img').fadeTo(FADE_TIME, 0);
      },
      error: function() {
        console.log('Error retrieving status counts!');
        $('#total').text('TOTAL  ERR');
        $('#expected').text('EXPECTED  ERR!');
        $('#checkedin').text('CHECKED IN  ERR!');
        $('#loading img').fadeTo(FADE_TIME, 0);
      }
    });
  };

  checkIn = function($btn, objectId) {
    $('button[data-objectId="' + objectId + '"]').attr('disabled', 'disabled');
    $btn.text('...');
    $('#loading img').fadeTo(FADE_TIME, 1);
    console.log('Checking in ' + objectId);
    return $.ajax({
      type: 'POST',
      url: '/admin/checkins_checkin',
      data: JSON.stringify({
        objectId: objectId
      }),
      contentType: 'application/json',
      success: function(res) {
        console.log(JSON.stringify(res, void 0, 2));
        if (res.success) {
          $btn.text('Done!');
          refreshStatusCounts();
          socket.emit('check in', objectId);
        } else {
          $btn.text('Error!');
          $('button[data-objectId="' + objectId + '"]').removeAttr('disabled', 'disabled');
        }
        $('#loading img').fadeTo(FADE_TIME, 0);
      },
      error: function() {
        $btn.text('Error!');
        $('button[data-objectId="' + objectId + '"]').removeAttr('disabled', 'disabled');
      }
    });
  };

}).call(this);
